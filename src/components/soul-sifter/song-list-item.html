<link href="../polymer/polymer.html" rel="import">

<link href="../iron-flex-layout/iron-flex-layout.html" rel="import">
<link href="../paper-dropdown/paper-dropdown.html" rel="import">
<link href="../paper-icon-button/paper-icon-button.html" rel="import">
<link href="../paper-item/paper-item.html" rel="import">
<link href="../paper-menu/paper-menu.html" rel="import">
<link href="../paper-menu-button/paper-menu-button.html" rel="import">

<link href="global-state.html" rel="import">
<link href="ss-star-rating.html" rel="import">
<link href="themes.html" rel="import">


<dom-module id="song-list-item">
  <style is="custom-style">
    :host {
      font-size: small;
    }


    ss-star-rating {
      margin: 0 6px;
    }
    ss-star-rating::shadow iron-icon {
      margin: 0 -5px;
    }


    .song-item {
      @apply(--layout-horizontal --layout-center);
      height: 30px;
      padding: 0 8px;
      margin: 0 10px;
    }
    .song-item div {
      margin: 3px;
    }
    .song-item paper-menu-button {
      display: none;
    }
    .song-item:hover paper-menu-button {
      display: inline-block;
    }
    .song-item paper-menu-button paper-icon-button {
      margin-top: 4px;
      padding: 0;
    }

    #cover {
      background-size: cover;
      height: 30px;
      width: 30px;
    }

    .key {
      position: relative;
      overflow: hidden;
      white-space: nowrap;
    }

    .fade-out:after {
      display: block;
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      width: 30px;
      content: "";
    }

    time {
      text-align: right;
      width: 64px;
    }

    .flex {
      @apply(--layout-flex);
    }
  </style>
  <template>
    <global-state values="{{global}}"></global-state>

    <div class="song-item" draggable="true" on-dragstart="{{dragSong}}" id="draggableItem">
      <div id="cover"></div>
      <div class="key fade-out flex">
        <span class="artist">{{song.artist}}</span>
        <span> - </span>
        <span class="title">{{song.title}}</span>
      </div>
      <paper-menu-button on-click="{{stopPropagation}}">
        <paper-icon-button icon="more-vert"></paper-icon-button>
        <paper-dropdown class="dropdown" transition="cascade">
          <paper-menu>
            <paper-item on-click="{{clickEditAction}}">Edit info</paper-item>
          </paper-menu>
        </paper-dropdown>
      </paper-menu-button>
      <div class="bpmDiff">{{bpmDiff}}</div>
      <ss-star-rating value="{{song.rating}}" read-only></ss-star-rating>
      <time class="added">{{localeDate}}</time>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'song-list-item',

    properties: {
      song: Object
    },

    observers: [
      'globalBpmChanged(global.bpm)',
      'globalMusicDirChanged(gobal.musicDir)'
    ],

    bpmDiff: '',

    localeDate: '',

    attached: function() {
      this.localeDate = new Date(this.song.dateAdded).toLocaleDateString();
      this.$.cover.style.backgroundImage = 'url("' + this.song.album.coverFilepath + '")';
    },

    globalMusicDirChanged: function(newValue) {
      //var filename = this.song.filePath.substr(this.song.filePath.lastIndexOf('/') + 1);
      //var fp = newValue + this.song.filePath.substr(this.song.filePath.search('mp3') + 3);
      //this.filepath = 'application/octet-stream:' + filename + ':file://' + fp;
    },

    globalBpmChanged: function(newValue) {
      if (this.global.bpm)
        this.bpmDiff = ((this.global.bpm / this.song.bpm - 1) * 100).toFixed(2);
    },

    dragSong: function(e) {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', 'extensis-filenames-type:' + this.song.filepath);
    },

    clickEditAction: function(e, detail, sender) {
      e.stopPropagation();
      this.asyncFire('page-song-edit', {song: this.song});
    },

    stopPropagation: function(e, detail, sender) {
      e.stopPropagation();
    },
  });
</script>
