<link href="../polymer/polymer.html" rel="import">

<link href="ss-global-behavior.html" rel="import">


<script>
  Polymer({
    is: 'ss-googleplaymusic',

    behaviors: [
      GlobalBehavior
    ],

    properties: {
    },

    attached: function() {
      if (!this.global.playmusic) {
        var PlayMusic = require('playmusic');
        var playmusic = new PlayMusic();
        var settings = new ss.SoulSifterSettings();
        var email = settings.getString('google.email');
        var appKey = settings.getString('google.appKey');
        if (!email) {
          return;
        }
        playmusic.init({email: email, password: appKey}, function(err) {
          if(err) {
            console.error('Login to Google Music failed.');
            console.error(err);
          } else {
            console.info('Succesfully connected to Google Music.');
          }
        }.bind(this));
        this.global.playmusic = playmusic;
      }
    },

    /**
     * Success callback takes a song.
     * Failure callback takes message, body, err, httpResonse
     */
    findSong: function(song, success, failure) {
      if (!this.connected) {
        return;
      }
      var maxResults = 3;
      this.playmusic.search(song.artist + ' ' + song.title, maxResults,
          function(data) {
            console.log(data);
            if (!data.entries) {
              failure('No results in Google Play Music for ' + song.artist + ' - ' + song.title, '', 1);
              return;
            }
            // We first filter by type. Types are:
            // 1 : track result
            // 2 : artist result
            // 3 : album result
            // Then we take the result with the highest score.
            var track = data.entries
                .filter(function(val) { return val.type == 1; })
                .sort(function(a, b) { return a.score < b.score; })
                .shift();
            if (!track) {
              failure('No track results in Google Play Music for ' + song.artist + ' - ' + song.title, '', 2);
              return;
            }
            success(track);
          },
          function(message, body, err, httpResponse) {
            console.warn('Error searching Google Play Music for ' + song.artist + ' - ' + song.title + '.  ' + message + '\
' + body + '\
' + err + '\
' + httpResponse);
            failure(message, body, err, httpResonse);
          }
      );
    },

    /**
     * Success callback takes a stream url
     * Failure callback takes message, body, err, httpResonse
     */
    findSongStreamUrl: function(song, success, failure) {
      if (!this.connected) {
        return;
      }
      var playmusic = this.playmusic;
      findSong(song, function(song) {
        playmusic.getStreamUrl(song.track.nid, success);
      },
      failure);
    },

    /**
     * Success callback takes a stream url
     * Failure callback takes message, body, err, httpResonse
     */
    findStreamUrl: function(nid, success, failure) {
      if (!this.connected) {
        return;
      }
      var playmusic = this.playmusic;
      playmusic.getStreamUrl(nid, success, failure);
    },

    findPlaylist: function(name, success, failure) {
      if (!this.connected) {
        return;
      }
      this.playmusic.getPlayLists(function(data) {
          console.log(data);
          if (!data.data.items) {
            failure('Unable to find any playlists.', '', 1);
            return;
          }
          var playlist = data.data.items
              .filter(function(val) { return val.name == name;})
              .shift();
          console.log(playlist);
          if (!playlist) {
            failure('No playlist with given name.', '', 2);
            return;
          }
          success(playlist);
        },
        failure
      );
    },

    /**
     * Add a new playlist, save the playlist id, and add the songs.
     */
    createPlaylist: function(playlist) {
      if (!playlist.gmusicId) {
        this.global.playmusic.addPlayList(playlist.name, function(err, mutationStatus) {
          if (err) {
            console.error('Unable to create playlist ' + playlist.name);
            console.error(err);
          } else {
            console.info('Successfully created playlist ' + playlist.name);
            playlist.gmusicId = mutationStatus.mutate_response[0].id;
            playlist.update();
          }
        });
      }
    },

    /**
     *
     */
    savePlaylist: function(playlist, success, failure) {
      var that = this;
      this.playmusic.addPlayList(playlist.name,
          function(data, response) {
            console.log('Successfully added playlist ' + playlist.name);
            var playlistId = data.mutate_response[0].id;
            var async = require('async');
            var songs = ss.SearchUtil.searchSongs(playlist.query, 0, [], playlist.styles, 100);
            async.eachLimit(songs,
              1,  // add one at a time. be nice to Google
              function(item, callback) {
                that.findSong(item,
                  function(song) {
                    that.playmusic.addTrackToPlayList(song.track.nid, playlistId,
                        function(data, res) { callback(); },
                        function(data, err, res) { callback(); });
                  },
                  function() {
                    callback();  // no errors for now
                  }
                );
              },
              function(err) {
                if (err) {
                  console.error('Unable to fill songs for playlist', err);
                  return;
                }
                console.log('Finished creating playlist.');
              }
            );
          },
          failure
      );
    },
  });
</script>
