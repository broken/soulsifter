<link href="../polymer/polymer.html" rel="import">

<link href="../core-icons/core-icons.html" rel="import">
<link href="../core-selection/core-selection.html" rel="import">
<link href="../core-signals/core-signals.html" rel="import">
<link href="../core-style/core-style.html" rel="import">
<link href="../paper-button/paper-button.html" rel="import">
<link href="../paper-dialog/paper-dialog.html" rel="import">
<link href="../paper-fab/paper-fab.html" rel="import">
<link href="../paper-input/paper-input.html" rel="import">

<link href="playlist-list-item.html" rel="import">
<link href="themes.html" rel="import">


<polymer-element name="playlist-list">

  <template>
    <link href="playlist-list.css" rel="stylesheet">
    <core-style ref="main"></core-style>
    
    <core-signals on-core-signal-playlists-changed="{{updatePlaylists}}"></core-signals>

    <div id="wrapper">
      <template repeat="{{p in playlists}}" id="playlistTpl">
        <playlist-list-item playlist="{{p}}" on-playlist-select="{{selectPlaylist}}"></playlist-list-item>
      </template>
      <core-selection multi id="selection" on-core-select="{{selectAction}}"></core-selection>
    </div>
    <paper-fab mini icon="add" on-click="{{createPlaylist}}"></paper-fab>
  </template>

<script>
    Polymer('playlist-list', {

      domReady: function() {
        this.updatePlaylists();
      },

      togglePlaylistDialog: function(e, detail, sender) {
        this.$.createPlaylistDialog.toggle();
      },

      createPlaylist: function(e, detail, sender) {
        var playlist = new ss.Playlist();
        this.asyncFire('page-playlist-edit', {playlist: playlist});
      },

      selectPlaylist: function(e, detail, sender) {
        this.$.selection.toggle(sender);
      },

      selectAction: function(e, detail, sender) {
        // unselect all
        for (var i = 0, item = this.$.playlistTpl.nextElementSibling;
            item && i < this.playlists.length;
            item = item.nextElementSibling, ++i) {
          if (item != detail.item && this.$.selection.isSelected(item)) {
            item.select(false);
            this.$.selection.toggle(item);
          }
        }
        // (de)select the selected
        detail.item.select(detail.isSelected);
        // update the query
        // TODO: get to work for non-smart playlists
        if (detail.isSelected) {
          this.asyncFire('genre-change', detail.item.playlist.styles);
          this.asyncFire('query-change', detail.item.playlist.query);
        }
      },

      updatePlaylists: function(e, detail, sender) {
        this.playlists = ss.Playlist.findAll();
      },
      
    });
  </script>
</polymer-element>