<link href="../polymer/polymer.html" rel="import">

<link href="../iron-flex-layout/iron-flex-layout.html" rel="import">
<link href="../iron-signals/iron-signals.html" rel="import">
<link href="../paper-scroll-header-panel/paper-scroll-header-panel.html" rel="import">
<link href="../paper-dropdown/paper-dropdown.html" rel="import">
<link href="../paper-icon-button/paper-icon-button.html" rel="import">
<link href="../paper-item/paper-item.html" rel="import">
<link href="../paper-menu/paper-menu.html" rel="import">
<link href="../paper-menu-button/paper-menu-button.html" rel="import">
<link href="../paper-toolbar/paper-toolbar.html" rel="import">

<link href="global-state.html" rel="import">
<link href="pitch-slider.html" rel="import">
<link href="ss-audio.html" rel="import">
<link href="ss-googleplaymusic.html" rel="import">
<link href="ss-star-rating.html" rel="import">
<link href="themes.html" rel="import">


<dom-module id="song-section">
  <style is="custom-style">
    :host {
      overflow: hidden;
    }

    paper-scroll-header-panel {
      position: static;
    }

    #header {
      background-size: cover;
      height: 256px;
    }

    .content {
      margin: 10px 15px;
    }

    #nav {
      @apply(--layout-horizontal --layout-justified);
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      margin: 0;
    }

    #nav paper-icon-button[disabled] {
      visibility: hidden;
    }

    audio {
      height: 30px;
      width: 100%;
    }

    .vertical {
      @apply(--layout-vertical);
    }

    .slider {
      @apply(--layout-horizontal --layout-center);
    }

    .btn {
      @apply(--layout-horizontal --layout-flex);
    }

    .flex {
      @apply(--layout-flex);
    }
  </style>
  <template>
    <global-state values="{{global}}"></global-state>
    <ss-googleplaymusic id="gpm"></ss-googleplaymusic>
    <iron-signals on-iron-signal-save-song-trail="{{saveSongTrail}}"></iron-signals>

    <paper-scroll-header-panel condenses keepCondensedHeader fit condensedHeaderHeight="40px" id="cshp">
      <paper-toolbar id="header" draggable="true" on-dragstart="{{dragSong}}">
        <div id="nav">
          <paper-icon-button icon="arrow-back" on-click="{{backAction}}" disabled$="{{!songTrailIndex}}"></paper-icon-button>
          <paper-icon-button icon="arrow-forward" on-click="{{forwardAction}}" disabled$="{{isIndexAtEndOfSongTrail(songTrailIndex, songTrail)}}"></paper-icon-button>
        </div>
      </paper-toolbar>
      <section class="content vertical">
        <div class="title">{{song.title}}</div>
        <div class="artist">{{song.artist}}</div>
        <ss-star-rating value="{{song.rating}}" read-only></ss-star-rating>
        <div class="track" self-end>{{song.album.track}}</div>
        <div class="track" self-end>{{song.album.name}}</div>
        <div class="released" self-end><span>{{song.album.releaseDateYear}}</span>-<span>{{song.album.releaseDateMonth}}</span>-<span>{{song.album.releaseDateDay}}</span></div>
        <div class="comments flex">{{song.comments}}</div>
        <div class="bpm">{{song.bpm}} bpm</div>
        <time class="added">{{localeDateTime}}</time>
        <div class="slider">
          <div>pitch</div>
          <pitch-slider></pitch-slider>
        </div>
        <div class="btn">
          <ss-audio class="flex" id="audio"></ss-audio>
          <paper-menu-button on-click="{{stopPropagation}}">
            <paper-icon-button icon="more-vert"></paper-icon-button>
            <paper-dropdown class="dropdown" transition="cascade" halign="right" valign="bottom">
              <paper-menu>
                <paper-item on-click="{{editAction}}">Edit info</paper-item>
              </paper-menu>
            </paper-dropdown>
          </paper-menu-button>
        </div>
      </section>
    </paper-scroll-header-panel>
  </template>
</dom-module>

<script>

  Polymer({
    is: 'song-section',

    properties: {
      songTrail: {
        type: Array,
        notify: true
      }
    },

    observers: {
      'globalSongChanged(global.song)'
    },

    localeDateTime: '',

    songTrailIndex: 0,

    created: function() {
      this.songTrail = [];
    },

    ready: function() {
      this.fs = require('fs');
    },

    globalSongChanged: function(song) {
      this.song = song;
      if (!song) {
        this.setCoverImage();
        return;
      }

      var entry = new ss.PlaylistEntry();
      entry.song = song;
      entry.position = this.songTrailIndex++;
      this.songTrail[entry.position] = entry;

      this.localeDateTime = new Date(this.song.dateAdded).toLocaleString();

      // audio source; use local, otherwise contact google api
      var that = this;
      this.fs.access(this.song.filepath, this.fs.F_OK | this.fs.R_OK, function(err) {
          if (!err) {
            that.$.audio.src = "file://" + that.song.filepath;
            that.setCoverImage(that.song.album.coverFilepath);
          } else {
            that.$.gpm.findSong(that.song,
                function(s) {
                  window.console.log(s);
                  that.$.gpm.findStreamUrl(s.track.nid,
                      function(url) {
                        that.$.audio.src = url;
                      },
                      function(msg, body, err, resp) { console.warn(msg); that.$.audio.src = ''; });
                  if (s.track.albumArtRef && s.track.albumArtRef.length) {
                    that.setCoverImage(s.track.albumArtRef[0].url);
                  } else {
                    that.setCoverImage();
                  }
                },
                function(msg, body, err, resp) {
                  console.warn(msg);
                  that.$.audio.src = '';
                  that.setCoverImage();
                }
              );
          }
        });
    },

    dragSong: function(e) {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', 'extensis-filenames-type:' + this.song.filepath);
    },

    backAction: function(e, detail, sender) {
      this.global.song = --this.songTrailIndex ? this.songTrail[--this.songTrailIndex].song : undefined;
    },

    forwardAction: function(e, detail, sender) {
      this.global.song = this.songTrail[this.songTrailIndex].song;
    },

    saveSongTrail: function(e, detail, sender) {
      var playlist = detail.playlist;
      for (var i = 0; i < this.songTrailIndex; ++i) {
        var entry = this.songTrail[i];
        entry.playlist = playlist;
        entry.save();
      }
    },

    setCoverImage: function(img) {
      var url = '';
      if (img) {
        url = 'url("' + img + '")';
      }
      this.$.cshp.shadowRoot.getElementById('headerBg').style.backgroundImage = url;
    },

    editAction: function(e, detail, sender) {
      e.stopPropagation();
      this.asyncFire('page-song-edit', {song: this.song});
    },

    stopPropagation: function(e, detail, sender) {
      e.stopPropagation();
    },
  });

  isIndexAtEndOfSongTrail(songTrailIndex, songTrail) {
    return songTrailIndex == songTrail.index;
  }
</script>
