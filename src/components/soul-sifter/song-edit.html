<link href="../polymer/polymer.html" rel="import">

<link href="../iron-flex-layout/iron-flex-layout.html" rel="import">
<link href="../paper-checkbox/paper-checkbox.html" rel="import">
<link href="../paper-input/paper-input.html" rel="import">

<link href="abstract-action-page.html" rel="import">
<link href="genre-list.html" rel="import">
<link href="ss-star-rating.html" rel="import">


<dom-module id="song-edit">
  <style is="custom-style">
    :host {
      font-size: 16px;
    }

    paper-input {
      position: relative;
      width: 240px;
    }
    paper-input::shadow paper-input-decorator {
      padding: 3px 0;
    }
    paper-input::shadow paper-input-decorator::shadow .floated-label {
      position: absolute;
      right: 260px;
      top: 14px;
    }

    paper-checkbox {
      margin: 10px 0;
    }

    #ratingContainer {
      position: relative;
      padding: 13px 0;
      width: 240px;
    }
    #ratingContainer .label {
      position: absolute;
      right: 260px;
      top: 15px;
    }
    .label {
      font-size: 0.75em;
    }
  </style>
  <template>
    <abstract-action-page id="abstractActionPage">
      <div class="fields">
        <paper-input label="Artist" value="{{song.artist}}" required="true" floatingLabel></paper-input>
        <paper-input label="Track Num" value="{{song.track}}" floatingLabel></paper-input>
        <paper-input label="Title" value="{{song.title}}" required="true" floatingLabel></paper-input>
        <paper-input label="Remixer" value="{{song.remixer}}" floatingLabel></paper-input>
        <paper-input label="Comments" value="{{song.comments}}" floatingLabel></paper-input>
        <div id="ratingContainer">
          <div class="label">Rating</div>
          <ss-star-rating value="{{song.rating}}"></ss-star-rating>
        </div>
        <paper-input label="BPM" value="{{song.bpm}}" floatingLabel></paper-input>
        <paper-input label="Key" value="{{song.tonicKey}}" floatingLabel></paper-input>
        <paper-checkbox checked="{{song.lowQuality}}">Low Quality</paper-checkbox>
        <paper-checkbox checked="{{song.album.mixed}}">Mixed</paper-checkbox>
      </div>
      <div class="fields">
        <paper-input label="Album Artist" value="{{song.album.artist}}" floatingLabel></paper-input>
        <paper-input label="Album Name" value="{{song.album.name}}" required="true" floatingLabel></paper-input>
        <paper-input label="POS" value="{{song.albumPart.pos}}" floatingLabel></paper-input>
        <paper-input label="Subtitle" value="{{song.albumPart.name}}" floatingLabel></paper-input>
        <paper-input label="Label" value="{{song.album.label}}" floatingLabel></paper-input>
        <paper-input label="Catalog ID" value="{{song.album.catalogId}}" floatingLabel></paper-input>
        <paper-input label="Genre" required="true" floatingLabel></paper-input>
        <paper-input label="Release Year" value="{{song.album.releaseDateYear}}" required="true" type="number" min="1600" max="2099" floatingLabel></paper-input>
        <paper-input label="Release Month" value="{{song.album.releaseDateMonth}}" type="number" min="1" max="12" floatingLabel></paper-input>
        <paper-input label="Release Day" value="{{song.album.releaseDateDay}}" type="number" min="1" max="31" floatingLabel></paper-input>
      </div>
      <div class="genres">
        <genre-list id="genreList" selection="{{song.styles}}"></genre-list>
      </div>
    </abstract-action-page>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'song-edit',

    properties: {
      song: Object,
      _newSongManager: {
        type: Object,
        value: function() { return new ss.NewSongManager(); }
      },
      _taggedSong: Object,
      filepaths: {
        type: Array,
        observer: '_filepathsChanged'
      }
    },

    attached: function() {
      // https://www.polymer-project.org/1.0/docs/migration.html#domready
      this.async(function() {
        this.$.abstractActionPage.setAcceptAction(this.save);
        this.$.abstractActionPage.setCancelAction(this.skip);
      }.bind(this));
    },

    save: function() {
      this._newSongManager.processSong(this.song);
      if (this._newSongManager.nextSong(this.song, this._taggedSong)) {
        this.fire('page-song-edit');
      }
    },

    skip: function() {
      this.song.sync();
      if (this._newSongManager.nextSong(this.song, this._taggedSong)) {
        this.fire('page-song-edit');
      }
    },

    _filepathsChanged: function() {
      this._newSongManager.import(this.filepaths);
      this._newSongManager.nextSong(this.song, this._taggedSong);
    },
  });
</script>
