<link href="../polymer/polymer.html" rel="import">

<link href="../iron-flex-layout/iron-flex-layout.html" rel="import">
<link href="../neon-animation/neon-animatable.html" rel="import">
<link href="../neon-animation/neon-animated-pages.html" rel="import">
<link href="../neon-animation/neon-animations.html" rel="import">
<link href="../paper-drawer-panel/paper-drawer-panel.html" rel="import">
<link href="../paper-header-panel/paper-header-panel.html" rel="import">
<link href="../paper-tabs/paper-tab.html" rel="import">
<link href="../paper-tabs/paper-tabs.html" rel="import">
<link href="../paper-toast/paper-toast.html" rel="import">
<link href="../paper-icon-button/paper-icon-button.html" rel="import">

<link href="genre-list.html" rel="import">
<link href="playlist-edit.html" rel="import">
<link href="playlist-list.html" rel="import">
<link href="song-edit.html" rel="import">
<link href="song-list.html" rel="import">
<link href="song-section.html" rel="import">
<link href="search-toolbar.html" rel="import">
<link href="ss-settings.html" rel="import">


<dom-module id="soul-sifter">
  <style is="custom-style">
    :host {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      color: var(--primary-text-color);
      background-color: var(--primary-background-color);
      font-size: 13px;
    }
    /* placed here since less preprocessor fails mixins. */
    paper-tab {
      --paper-tab: {
        background-color: var(--paper-tab-bg);
      };
      --paper-tab-content: {
        font-weight: 500 !important;
      };
    }

    #drawer {
      background-color: var(--primary-background-color);
      overflow: hidden;
    }


    /* remove preset colors */
    :host /deep/ input {
      color: inherit;
    }
    :host /deep/ core-field {
      color: inherit;
    }
    :host /deep/ paper-toolbar {
      background-color: inherit;
      font-size: 1em;
    }
    :host /deep/ paper-input {
      color: inherit;
    }

    neon-animated-pages#main {
      overflow: hidden;
      height: 100%;
    }

    paper-icon-button {
      position: absolute;
      display: none;
      width: 24px;
      height: 24px;
      font-size: 16px;
      margin: 8px;
    }

    core-drawer-panel[narrow] paper-icon-button {
      display: inline-block
    }

    paper-toast {
      left: auto;
      right: 20px;
    }

    .vertical {
      @apply(--layout-vertical);
    }
    .flex {
      @apply(--layout-flex);
    }
  </style>
  <template>
    <neon-animated-pages id="main" selected="{{section}}" entry-animation="slide-from-right-animation" exit-animation="slide-left-animation">
      <neon-animatable>
        <paper-drawer-panel>
          <section drawer id="drawer">
            <paper-tabs selected="{{selectedTab}}">
              <paper-tab id="paper_tab-song">Song</paper-tab>
              <paper-tab id="paper_tab-genres" active>Genres</paper-tab>
              <paper-tab id="paper_tab-playlists">Playlists</paper-tab>
            </paper-tabs>
            <neon-animated-pages selected="{{selectedTab}}" class="flex" entry-animation="slide-from-right-animation" exit-animation="slide-left-animation">
              <neon-animatable><song-section song-trail="{{songTrail}}"></song-section></neon-animatable>
              <neon-animatable>
              <genre-list selection="{{genres}}"></genre-list>
              </neon-animatable>
              <neon-animatable><playlist-list on-query-change="changeQuery" on-genre-change="updateGenres"></playlist-list></neon-animatable>
            </neon-animated-pages>
          </section>
          <paper-header-panel main>
            <search-toolbar query="{{query}}" dj-search="{{djSearch}}" class="paper-header">
              <paper-icon-button paper-drawer-toggle icon="menu"></paper-icon-button>
            </search-toolbar>
            <song-list query="{{query}}" dj-search="{{djSearch}}" song-trail="{{songTrail}}" class="fit"></song-list>
          </paper-header-panel>
        </paper-drawer-panel>
      </neon-animatable>
      <neon-animatable>
        <playlist-edit playlist="{{playlist}}"></playlist-edit>
      </neon-animatable>
      <neon-animatable>
        <song-edit song="{{song}}"></song-edit>
      </neon-animatable>
      <neon-animatable>
        <ss-settings></ss-settings>
      </neon-animatable>
    </neon-animated-pages>
    <paper-toast id="toast" text="{{errorText}}" duration="5000" autoCloseDisabled></paper-toast> 
  </template>
</dom-module>

<script>
  Polymer({
    is: 'soul-sifter',

    properties: {
      selectedTab: {
        type: Number,
        value: 1
      },
      section: {
        type: Number,
        value: 0
      }
    },

    djSearch: true,

    attached: function() {
      // https://www.polymer-project.org/1.0/docs/migration.html#domready
      this.async(function() {
        /* theming */
        // CoreStyle.g.theme.init();

        /* setup listeners */
        var that = this;
        this.addEventListener('page-main', function(e) {
          that.section = 0;
        });
        this.addEventListener('page-playlist-edit', function(e) {
          that.section = 1;
          that.playlist = e.detail.playlist;
        });
        this.addEventListener('page-song-edit', function(e) {
          that.section = 2;
          that.song = e.detail.song;
        });
        this.addEventListener('page-settings', function(e) {
          that.section = 3;
        });
        this.addEventListener('error-alert', function(e) {
          console.log(e.detail.msg);
          that.errorText = e.detail.msg;
          that.$.toast.show();
        });
      }.bind(this));
    },

    changeQuery: function(e, detail, sender) {
      this.query = detail;
    },

    updateGenres: function(e, detail, sender) {
      this.genres = detail;
    },

    genresChanged: function(spliceOrOldValue, undefOrNewValue) {
      // The first selection uses a property observer, while subsequent calls use an array observer and calls this method with splice changes rather than the old & new values
      this.fire('iron-signal', {name: 'genres-changed', data: this.genres});
    },
  });
</script>
