<link href="../polymer/polymer.html" rel="import">

<link href="../core-field/core-field.html" rel="import">
<link href="../core-icon-button/core-icon-button.html" rel="import">
<link href="../core-icons/core-icons.html" rel="import">
<link href="../core-input/core-input.html" rel="import">
<link href="../core-localstorage/core-localstorage.html" rel="import">
<link href="../core-signals/core-signals.html" rel="import">
<link href="../core-style/core-style.html" rel="import">
<link href="../core-toolbar/core-toolbar.html" rel="import">
<link href="../css/roboto.css" rel="stylesheet">
<link href="../paper-dialog/paper-dialog.html" rel="import">

<!-- <link href="create-song.html" rel="import"> -->
<link href="global-state.html" rel="import">
<link href="search-info.html" rel="import">
<link href="themes.html" rel="import">


<polymer-element name="search-toolbar" attributes="query">

  <template>
    <link href="search-toolbar.css" rel="stylesheet">
    <core-style ref="main"></core-style>

    <global-state values="{{global}}"></global-state>
    <core-localstorage name="soul-sifter-music-directory" value="{{musicDir}}"></core-localstorage>

    <core-toolbar class="{{ {'medium-tall': isTall} | tokenList }}">
      <content></content>
      <core-field class="indent">
        <core-icon-button icon="search" on-click="{{searchAction}}"></core-icon-button>
        <core-input id="search_input" placeholder="search" flex value="{{query}}"></core-input>
        <core-icon-button icon="info-outline" on-click="{{toggleSearchInfoDialog}}"></core-icon-button>
      </core-field>
      <div flex></div>
      <core-icon-button icon="add-circle" on-click="{{toggleCreateSongDialog}}" id="createSongButton"></core-icon-button>
      <core-icon-button icon="settings" on-click="{{toggleSettingsDialog}}"></core-icon-button>
      <core-icon-button icon="filter" on-click="{{toggleIsTall}}"></core-icon-button>
      <!-- middle row -->
      <!-- bottom row -->
      <div flex class="bottom {{ {hide: !isTall} | tokenList }}"></div>
      <div class="bottom {{ {hide: !isTall} | tokenList }}">
        <core-icon-button icon="query-builder" on-click="{{analyzeBpms}}"></core-icon-button>
        Analyze BPMs
      </div>
    </core-toolbar>
    <paper-dialog backdrop layered id="searchInfoDialog">
      <search-info></search-info>
    </paper-dialog>
    <paper-dialog backdrop layered heading="Settings" id="settingsDialog">
      <paper-input floatingLabel label="Music directory" value="{{musicDir}}"></paper-input>
    </paper-dialog>
    <paper-dialog backdrop layered heading="Create Song" id="createSongDialog">
      <!-- <create-song></create-song> -->
    </paper-dialog>
  </template>

  <script>
    Polymer('search-toolbar', {

      isTall: false,

      musicDir: '',

      domReady: function() {
        this.$.createSongButton.ondragover = function() {
          this.icon = 'add-circle-outline';
        };
        this.$.createSongButton.ondragend = function() {
          this.icon = 'add-circle';
        };
        this.$.createSongButton.ondrop = function(e) {
          e.preventDefault();
          for (var i = 0; i < e.dataTransfer.files.length; ++i) {
            var song = new ss.Song();
            window.console.log(song);
            /*song.setFilepath(e.dataTransfer.files[i].path);
            window.console.log(e.dataTransfer.files[i].path);
            ss.MusicManager.readTagsFromSong(song);
            window.console.log(song);*/
          }
        };
      },

      toggleIsTall: function(e, detail, sender  ) {
        this.isTall = !this.isTall;
      },

      toggleSearchInfoDialog: function(e, detail, sender) {
        this.$.searchInfoDialog.toggle();
      },

      toggleSettingsDialog: function(e, detail, sender) {
        this.$.settingsDialog.toggle();
      },

      toggleCreateSongDialog: function(e, detail, sender) {
        this.$.createSongDialog.toggle();
      },

      searchAction: function(e, detail, sender) {
        this.asyncFire('core-signal', {name: 'search'});
      },

      musicDirChanged: function(oldValue, newValue) {
        if (this.global)
          this.global.musicDir = newValue;
      },

      globalChanged: function(oldValue, newValue) {
        if (this.musicDir)
          this.global.musicDir = this.musicDir;
      },

      analyzeBpms: function(e, detail, sender) {
        ss.AudioAnalyzer.analyzeBpms();
      },
    });

  </script>
</polymer-element>