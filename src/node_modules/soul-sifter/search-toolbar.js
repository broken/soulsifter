// <link href="../polymer/polymer.html" rel="import">

// <link href="../iron-icons/iron-icons.html" rel="import">
// <link href="../paper-dialog/paper-dialog.html" rel="import">
// <link href="../paper-icon-button/paper-icon-button.html" rel="import">
// <link href="../paper-input/paper-input.html" rel="import">
// <link href="../paper-toggle-button/paper-toggle-button.html" rel="import">

// <link href="search-info.html" rel="import">
// <link href="ss-global-behavior.html" rel="import">
// <link href="ss-options-menu.html" rel="import">
// <link href="options-menu-item.html" rel="import">
// <link href="ss-search-options.html" rel="import">

import { css, html, LitElement } from "@polymer/lit-element";

import "@polymer/paper-dialog/paper-dialog.js";
import "@polymer/paper-input/paper-input.js";

import { BpmMixin } from "./mixin-bpm.js";
import { QueryMixin } from "./mixin-query.js";
import { SearchMixin } from "./mixin-search.js";
import "./icon-button.js";
import "./options-menu.js";
import "./options-menu-item.js";
import "./search-options.js";

class SearchToolbar extends BpmMixin(QueryMixin(SearchMixin(LitElement))) {
  render() {
    return html`
      <icon-button @click=${this.requestSearch} icon="search"></icon-button>
      <paper-input label="search" value="${this.query}" class="flex" no-label-float @input=${this.queryInputChanged} id="queryInput"></paper-input>
      <icon-button @click=${this.toggleSearchInfoDialog} icon="info_outline"></icon-button>
      <icon-button @click=${this.toggleSearchOptionsDialog} icon="build"></icon-button>
      <paper-input label="bpm" value="${this.bpm}" id="bpm" no-label-float @input=${this.bpmInputChanged} id="bpmInput"></paper-input>
      <icon-button @click=${this.openCreateSongPage} icon="add_circle" id="createSongButton"></icon-button>
      <icon-button @click=${this.openSettingsPage} icon="settings" id="createSongButton"></icon-button>
      <options-menu>
        <options-menu-item @click="${this.addSongFromUrl}">Add Song From URL</options-menu-item>
        <options-menu-item on-click="updateSongAttributesFromTags">Update Song Attributes From Tags</options-menu-item>
        <options-menu-item on-click="analyzeBpms">Analyze BPMs</options-menu-item>
        <options-menu-item on-click="analyzeDurations">Analyze Durations</options-menu-item>
        <options-menu-item on-click="syncGoogleMusic">Sync Google Music</options-menu-item>
        <options-menu-item on-click="syncGoogleMusicPlaylists">Sync Google Music Playlists</options-menu-item>
        <options-menu-item on-click="showDevTools">View Developer Tools</options-menu-item>
      </options-menu>
      <paper-dialog id="searchInfoDialog" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
        <search-info></search-info>
      </paper-dialog>
      <paper-dialog id="searchOptionsDialog">
        <search-options></search-options>
      </paper-dialog>
    `;
  }

  static get properties() {
    return {
      nwGui: { type: Object },
    }
  }

  constructor() {
    super();
    this.bpm = '';
    this.nwGui = require('nw.gui');
  }

  requestSearch(e) {
    this.changeQuery(this.query);
  }

  queryInputChanged(e) {
    // only update/search if it's not actively being changed
    let query = this.shadowRoot.getElementById('queryInput').value;
    this.query = query;
    setTimeout(() => { if (this.query == query) this.changeQuery(query); }, 750);
  }

  bpmInputChanged(e) {
    // only update if it's not actively being changed
    let bpm = this.shadowRoot.getElementById('bpmInput').value;
    this.bpm = bpm;
    setTimeout(() => { if (this.bpm == bpm) this.changeBpm(bpm); }, 750);
  }

    attached() {
      Polymer.RenderStatus.afterNextRender(this, function() {
        this.$.createSongButton.ondragover = function() {
          this.icon = 'add-circle-outline';
          return false;
        };
        this.$.createSongButton.ondragleave = function() {
          this.icon = 'add-circle';
          return false;
        };
        this.$.createSongButton.ondrop = function(e) {
          e.preventDefault();
          this.icon = 'add-circle';
          var files = e.dataTransfer.files;
          var filepaths = new Array();
          for (var i = 0; i < files.length; ++i) {
            filepaths.push(files[i].path);
          }
          this.fire('page-song-edit', {filepaths: filepaths});
          return false;
        };
      }.bind(this));
    }

    analyzeBpms(e, detail, sender) {
      ss.AudioAnalyzer.analyzeBpms();
    }

    analyzeDurations(e, detail, sender) {
      ss.AudioAnalyzer.analyzeDurations();
    }

    updateSongAttributesFromTags(e, detail, sender) {
      ss.TagService.updateSongAttributesFromTags();
    }

    showDevTools(e, detail, sender) {
      this._nwGui.Window.get().showDevTools();
    }

    syncGoogleMusic(e, detail, sender) {
      var child_process = require('child_process');
      var path = require('path');
      var downloadProcess = child_process.fork(path.join(nw.__dirname, 'workers', 'syncgooglemusic.js'), [], {cwd: nw.__dirname});
    }

    syncGoogleMusicPlaylists(e, detail, sender) {
      var child_process = require('child_process');
      var path = require('path');
      var downloadProcess = child_process.fork(path.join(nw.__dirname, 'workers', 'syncgooglemusicplaylists.js'), [], {cwd: nw.__dirname});
    }

  addSongFromUrl(e) {
    var url = nw.Clipboard.get().get('text');
    window.console.log('Audio url = ' + url);

    var filepaths = ss.MusicVideoService.downloadAudio(url);
    if (filepaths.length > 0) {
      let event = new CustomEvent('song-edit', { detail: { filepaths: filepaths } });
      window.dispatchEvent(event);
    } else {
      window.console.log('Failed to download audio from url ' + url);
    }
  }

  toggleSearchInfoDialog(e, detail, sender) {
    // this.$.searchInfoDialog.toggle();
  }

  toggleSearchOptionsDialog(e) {
    this.shadowRoot.getElementById('searchOptionsDialog').toggle();
  }

  openSettingsPage(e, detail, sender) {
    //this.fire('page-settings');
  }

  openCreateSongPage(e, detail, sender) {
    // var song = new ss.Song();
    // this.fire('page-song-edit', {song: song});
  }

  static get styles() {
    return [
      css`
        :host {
          background-color: var(--search-toolbar-background);
          display: flex;
          flex-direction: row;
          height: 42px;
          padding-top: 5px;
          padding-left: 17px;
          box-shadow: 0 2px 4px -1px rgba(0,0,0,.2), 0 4px 5px 0 rgba(0,0,0,.14), 0 1px 10px 0 rgba(0,0,0,.12);
        }
        icon-button {
          --mdc-icon-size: 24px;
          color: var(--primary-text-color);
        }
        icon-button, options-menu {
          padding: 8px;
        }
        #searchInfoDialog {
          max-width: none !important;
        }
        #bpm {
          width: 64px;
        }
        .flex {
          flex: 1;
          flex-basis: auto;
        }
        .menuItem {
          white-space: nowrap;
        }
      `
    ];
  }
}

window.customElements.define('search-toolbar', SearchToolbar);
