import { css, html, LitElement } from "@polymer/lit-element";

import "@polymer/paper-dialog/paper-dialog.js";
import "@polymer/paper-input/paper-input.js";

import { BpmMixin } from "./mixin-bpm.js";
import { QueryMixin } from "./mixin-query.js";
import { SearchMixin } from "./mixin-search.js";
import "./icon-button.js";
import "./options-menu.js";
import "./options-menu-item.js";
import "./search-info.js";
import "./search-options.js";


class SearchToolbar extends BpmMixin(QueryMixin(SearchMixin(LitElement))) {
  render() {
    return html`
      <icon-button @click=${this.requestSearch} icon="search"></icon-button>
      <paper-input label="search" value="${this.query}" class="flex" no-label-float @input=${this.queryInputChanged} id="queryInput"></paper-input>
      <icon-button @click=${this.toggleSearchInfoDialog} icon="info_outline"></icon-button>
      <icon-button @click=${this.toggleSearchOptionsDialog} icon="build"></icon-button>
      <paper-input label="bpm" value="${this.bpm}" id="bpm" no-label-float @input=${this.bpmInputChanged} id="bpmInput"></paper-input>
      <icon-button @click=${this.openCreateSongPage} icon="add_circle" id="createSongButton" @drop="${this.dropCreateSongButton}" @dragover="${this.dragOverCreateSongButton}" @dragleave="${this.dragLeaveCreateSongButton}"></icon-button>
      <icon-button @click=${this.openSettingsPage} icon="settings"></icon-button>
      <options-menu>
        <options-menu-item @click="${this.addSongFromUrl}">Add Song From URL</options-menu-item>
        <options-menu-item @click="${this.updateSongAttributesFromTags}">Update Song Attributes From Tags</options-menu-item>
        <options-menu-item @click="${this.analyzeBpms}">Analyze BPMs</options-menu-item>
        <options-menu-item @click="${this.analyzeDurations}">Analyze Durations</options-menu-item>
        <options-menu-item @click="${this.syncGoogleMusic}">Sync Google Music</options-menu-item>
        <options-menu-item @click="${this.syncGoogleMusicPlaylists}">Sync Google Music Playlists</options-menu-item>
        <options-menu-item @click="${this.showDevTools}">View Developer Tools</options-menu-item>
      </options-menu>
      <paper-dialog id="searchInfoDialog">
        <search-info></search-info>
      </paper-dialog>
      <paper-dialog id="searchOptionsDialog">
        <search-options></search-options>
      </paper-dialog>
    `;
  }

  static get properties() {
    return {
    }
  }

  constructor() {
    super();
    this.bpm = '';
  }

  requestSearch(e) {
    this.changeQuery(this.query);
  }

  queryInputChanged(e) {
    // only update/search if it's not actively being changed
    let query = this.shadowRoot.getElementById('queryInput').value;
    this.query = query;
    setTimeout(() => { if (this.query == query) this.changeQuery(query); }, 750);
  }

  bpmInputChanged(e) {
    // only update if it's not actively being changed
    let bpm = this.shadowRoot.getElementById('bpmInput').value;
    this.bpm = bpm;
    setTimeout(() => { if (this.bpm == bpm) this.changeBpm(bpm); }, 750);
  }

  dragOverCreateSongButton(e) {
    this.shadowRoot.getElementById('createSongButton').icon = 'add_circle_outline';
    return false;
  }

  dragLeaveCreateSongButton(e) {
    this.shadowRoot.getElementById('createSongButton').icon = 'add_circle';
    return false;
  }

  dropCreateSongButton(e) {
    e.preventDefault();
    this.shadowRoot.getElementById('createSongButton').icon = 'add_circle';
    var files = e.dataTransfer.files;
    var filepaths = new Array();
    for (var i = 0; i < files.length; ++i) {
      filepaths.push(files[i].path);
    }
    let event = new CustomEvent('song-edit', { detail: { filepaths: filepaths } });
    window.dispatchEvent(event);
    return false;
  }

  analyzeBpms(e) {
    ss.AudioAnalyzer.analyzeBpms();
  }

  analyzeDurations(e) {
    ss.AudioAnalyzer.analyzeDurations();
  }

  updateSongAttributesFromTags(e) {
    ss.TagService.updateSongAttributesFromTags();
  }

  showDevTools(e) {
    let nwGui = require('nw.gui');
    nwGui.Window.get().showDevTools();
  }

  syncGoogleMusic(e) {
    var child_process = require('child_process');
    var path = require('path');
    var downloadProcess = child_process.fork(path.join(nw.__dirname, 'workers', 'syncgooglemusic.js'), [], {cwd: nw.__dirname});
  }

  syncGoogleMusicPlaylists(e) {
    var child_process = require('child_process');
    var path = require('path');
    var downloadProcess = child_process.fork(path.join(nw.__dirname, 'workers', 'syncgooglemusicplaylists.js'), [], {cwd: nw.__dirname});
  }

  addSongFromUrl(e) {
    var url = nw.Clipboard.get().get('text');
    window.console.log('Audio url = ' + url);

    var filepaths = ss.MusicVideoService.downloadAudio(url);
    if (filepaths.length > 0) {
      let event = new CustomEvent('song-edit', { detail: { filepaths: filepaths } });
      window.dispatchEvent(event);
    } else {
      window.console.log('Failed to download audio from url ' + url);
    }
  }

  toggleSearchInfoDialog(e) {
    this.shadowRoot.getElementById('searchInfoDialog').toggle();
  }

  toggleSearchOptionsDialog(e) {
    this.shadowRoot.getElementById('searchOptionsDialog').toggle();
  }

  openSettingsPage(e) {
    let event = new CustomEvent('settings-edit', { });
    window.dispatchEvent(event);
  }

  openCreateSongPage(e) {
    let song = new ss.Song();
    let event = new CustomEvent('song-edit', { detail: { song: song } });
    window.dispatchEvent(event);
  }

  static get styles() {
    return [
      css`
        :host {
          background-color: var(--search-toolbar-background);
          display: flex;
          flex-direction: row;
          height: 42px;
          padding-top: 5px;
          padding-left: 17px;
          box-shadow: 0 2px 4px -1px rgba(0,0,0,.2), 0 4px 5px 0 rgba(0,0,0,.14), 0 1px 10px 0 rgba(0,0,0,.12);
        }
        icon-button {
          --mdc-icon-size: 24px;
          color: var(--primary-text-color);
        }
        icon-button, options-menu {
          padding: 8px;
        }
        #searchInfoDialog {
          max-width: none !important;
        }
        #bpm {
          width: 64px;
        }
        .flex {
          flex: 1;
          flex-basis: auto;
        }
        .menuItem {
          white-space: nowrap;
        }
      `
    ];
  }
}

window.customElements.define('search-toolbar', SearchToolbar);
