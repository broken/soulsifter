import { css, html, LitElement } from "@polymer/lit-element";

import "@material/mwc-fab/mwc-fab.js";

import "./genre-list-item.js";
import { GenresMixin } from "./mixin-genres.js";


class GenreList extends GenresMixin(LitElement) {
  render() {
    let genreListItems = this.genreParents.map(g => html`<genre-list-item .genre="${g}" @genre-toggle="${this.toggleGenreSelection}" ?optionsmenu="${this.main}" ?singleselect="${this.singleSelect}"></genre-list-item>`);
    let fab = this.main ? html`<mwc-fab mini icon="add" @click="${this.createGenre}"></mwc-fab>` : html``;
    return html`
      ${genreListItems}
      ${fab}
    `;
  }

  static get properties() {
    return {
      genreParents: { type: Array },
      singleSelect: { type: Boolean },
      main: { type: Boolean },
    }
  }

  constructor() {
    super();
    this.genreParents = ss.Style.findAllParents().sort((a, b) => a.name.localeCompare(b.name));
    this.singleSelect = false;
    this.main = false;
    if (!this.genres) this.genres = [];
    this.updateGenresListener = (e) => this.genreParents = ss.Style.findAllParents().sort((a, b) => a.name.localeCompare(b.name));
  }

  connectedCallback() {
    super.connectedCallback();
    window.addEventListener('update-genres', this.updateGenresListener);
  }

  disconnectedCallback() {
    window.removeEventListener('update-genres', this.updateGenresListener);
    super.disconnectedCallback();
  }

  updated(changedProperties) {
    changedProperties.forEach((oldValue, propName) => {
      if (propName == 'genres') {
        this.genresChanged(this.genres);
      }
    });
  }

  genresChanged(genres) {
    this.genres = genres;
    for (var i = 0, childNodes = this.shadowRoot.querySelectorAll('genre-list-item');
         i < childNodes.length; ++i) {
      childNodes[i].selectIffInArray(this.genres);
    }
  }

  toggleGenreSelection(e) {
    try {
      for (var i = 0; i < this.genres.length; ++i) {
        if (this.genres[i].id == e.detail.genre.id) {
          this.genres.splice(i, 1);
          return;
        }
      }
      // TODO do I really need this?  var g = new ss.Style(detail.genre);
      this.genres.push(e.detail.genre);
    } finally {
      if (this.main) this.changeGenres(this.genres);
    }
  }

  createGenre(e, detail, sender) {
    let genre = new ss.Style();
    let event = new CustomEvent('genre-edit', { detail: genre });
    window.dispatchEvent(event);
  }

  static get styles() {
    return [
      css`
        :host {
          padding: 0 0 20px 0;
          height: 100%;
          overflow-x: hidden;
          overflow-y: scroll;
        }
        mwc-fab {
          bottom: 15px;
          position: relative;
          left: 182px;
        }
      `
    ];
  }
}

window.customElements.define('genre-list', GenreList);
