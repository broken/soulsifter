// <link href="../polymer/polymer.html" rel="import">

// <link href="../iron-collapse/iron-collapse.html" rel="import">
// <link href="../iron-flex-layout/iron-flex-layout.html" rel="import">
// <link href="../paper-icon-button/paper-icon-button.html" rel="import">
// <link href="../paper-material/paper-material.html" rel="import">
// <link href="../paper-ripple/paper-ripple.html" rel="import">

// <link href="ss-options-menu.html" rel="import">
// <link href="ss-options-menu-item.html" rel="import">

import { css, html, LitElement } from "@polymer/lit-element";

import "./icon-button.js";
import "./options-menu.js";
import "./options-menu-item.js";

class GenreListItem extends LitElement {
  render() {
    let icon = this.opened ? 'expand_less' : 'expand_more';
    let subgenres = this.getSubGenres().map(g =>
        html`<genre-list-item .genre="${g}" @expand-parents="${this.expand}" ?hidden="${!this.opened}" ?singleselect="${this.singleSelect}" ?optionsmenu="${this.optionsMenu}"></genre-list-item>`);
    let button = subgenres.length ? html`<icon-button icon=${icon} @click="${this.toggleExpansion}"></icon-button>` : html`<icon-button></icon-button>`;
    let menu = !this.optionsMenu ? html`` : html`<options-menu><options-menu-item>Edit genre</options-menu-item></options-menu>`;
    let mo = html`
        <paper-material class$="[[_computeSelectedClass(isSelected)]]" style$="[[_computePaddingLeftStyle(indent)]]" on-tap="_toggleSelect" id="item" elevation="0">
          <paper-ripple></paper-ripple>
        </paper-material>
      </div>
      <iron-collapse id="collapse" opened="{{opened}}">
        <template is="dom-repeat" items="[[_getSubGenres(genre)]]" id="subGenreTpl">
          <genre-list-item genre="[[item]]" indent="[[_incIndent(indent)]]" on-expand-parents="expand" single-select="[[singleSelect]]" main="[[main]]"></genre-list-item>
        </template>
      </iron-collapse>`;
    return html`
      <div class="itemContainer">
        <div class="item" ?selected="${this.selected}">
          ${button}
          <span @click="${this.toggleSelect}">${this.genre.name}</span>
          ${menu}
        </div>
        ${subgenres}
      </div>
    `;
  }

  static get properties() {
    return {
      genre: { type: Object },
      selected: { type: Boolean },
      opened: { type: Boolean },
      singleSelect: { type: Boolean },
      optionsMenu: { type: Boolean },
    }
  }

  constructor() {
    super();
    this.opened = false;
    this.selected = false;
    this.singleSelect = false;
    this.optionsMenu = false;
  }

  getSubGenres() {
    return this.genre.children.sort((a, b) => a.name.localeCompare(b.name));
  }

  toggleExpansion(e, detail, sender) {
    // if (!this.genre.subGenre || this.genre.subGenre.length <= 0) return;
    this.opened = !this.opened;
    // e.stopPropagation();  // TODO remove
    this.requestUpdate();
  }

  toggleSelect(e, detail, sender) {
    this.select(!this.selected);
  }

  select(selected) {
    if ((selected && !this.selected) ||
        (!selected && this.selected)) {
      this.selected = !this.selected;
      let event = new CustomEvent('genre-toggle', {
          detail: { genre: this.genre },
          bubbles: true,
          composed: true });
      this.dispatchEvent(event);
    }
    if (!this.singleSelect && this.genre.children && this.genre.children.length > 0) {
      for (var i = 0, childNodes = this.shadowRoot.querySelectorAll('genre-list-item');
           i < childNodes.length; ++i) {
        childNodes[i].select(this.selected);
      }
    }
  }

  selectIffInArray(genres) {
    if (!genres) return;
    // select this and request parents to expand if found in array
    var selected = false;
    for (var i = 0; i < genres.length; ++i) {
      if (genres[i].id === this.genre.id) {
        selected = true;
        let event = new CustomEvent('expand-parents', {
            detail: { genre: this.genre },
            bubbles: true,
            composed: true });
        this.dispatchEvent(event);
      }
    }
    this.selected = selected;
    // have all child elements check if they're in the array
    for (var i = 0, childNodes = this.shadowRoot.querySelectorAll('genre-list-item');
         i < childNodes.length; ++i) {
      childNodes[i].selectIffInArray(genres);
    }
  }

  expand() {
    this.opened = true;
  }

    _editAction(e, detail, sender) {
      e.preventDefault();
      this.fire('page-genre-edit', {genre: this.genre});
    }

  static get styles() {
    return [
      css`
        .itemContainer {
          margin: 7px 0 0 18px;
          display: flex;
          flex-direction: column;
        }
        .item {
          height: 24px;
          flex: 1 1 auto;
          display: flex;
          flex-direction: row;
          align-items: center;  
        }
        .item[selected] {
          background-color: var(--ss-genre-list-item-select-color);
        }
        .item span {
          flex: 1 1 auto;
        }
        icon-button {
          width: 24px;
        }



        paper-icon-button {
          transform: scale(.6);
        }


        ss-options-menu {
          --iron-icon-height: 16px;
          --iron-icon-width: 16px;
        }
        #item ss-options-menu::shadow #btn {
          display: none;
        }
        #item:hover ss-options-menu::shadow #btn {
          display: block;
        }
      `
    ];
  }
}

window.customElements.define('genre-list-item', GenreListItem);
